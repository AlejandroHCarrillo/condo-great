<div class="p-4 max-w-2xl mx-auto">
  <div class="flex items-center justify-between gap-4 mb-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fa-solid fa-receipt text-primary"></i>
      {{ title }}
    </h1>
    <button type="button" class="btn btn-secondary text-white" (click)="cancel()">
      Regresar
    </button>
  </div>

  <div class="bg-base-200 rounded-lg p-4">
  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <span class="loading loading-spinner loading-lg"></span>
      <span class="ml-4">Cargando...</span>
    </div>
  } @else {
    @if (errorMessage()) {
      <div class="alert alert-error mb-4">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span>{{ errorMessage() }}</span>
      </div>
    }

    <form class="space-y-6" (ngSubmit)="openConfirmModal($event)">
      @if (isEditMode()) {
        <div class="flex flex-wrap items-center gap-3">
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="font-bold text-black shrink-0">Residente:</span>
            <span>{{ displayedResidentName() }}</span>
          </div>
          <div class="flex items-center gap-2">
            <label for="fecha" class="font-bold text-black shrink-0">Fecha:</label>
            <input id="fecha" type="date" class="input input-bordered input-sm w-[10.5rem]" [(ngModel)]="form.fecha" name="fecha" required />
          </div>
        </div>
      } @else {
        <div class="form-control w-full">
          @if (selectedComunidadName()) {
            <p class="font-bold text-black mb-3">Comunidad: {{ selectedComunidadName() }}</p>
          }
          <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <label for="residentId" class="font-bold text-black shrink-0">Residente:</label>
              <select
                id="residentId"
                class="select select-bordered flex-1 min-w-0"
                [(ngModel)]="form.residentId"
                name="residentId"
                required
                [disabled]="!!residentIdFromRoute() || form.residentId === 'all'"
              >
                <option value="">Seleccione un residente</option>
                @if (!residentIdFromRoute() && residentsOptions().length) {
                  <option value="all">Todos los residentes de la comunidad</option>
                }
                @for (r of residentsOptions(); track r.residentId ?? r.id) {
                  <option [value]="r.residentId ?? r.id">{{ r.fullname }} {{ r.number ? '(' + r.number + ')' : '' }}</option>
                }
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label for="fecha" class="font-bold text-black shrink-0">Fecha:</label>
              <input id="fecha" type="date" class="input input-bordered input-sm w-[10.5rem]" [(ngModel)]="form.fecha" name="fecha" required />
            </div>
          </div>
        </div>
      }

      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <label for="frecuencia" class="font-bold text-black shrink-0">Frecuencia:</label>
          <select id="frecuencia" class="select select-bordered w-full max-w-xs" [(ngModel)]="frecuencia" name="frecuencia" (ngModelChange)="onFrecuenciaChange()">
            <option value="Unico">Único</option>
            <option value="Mensual">Mensual</option>
            <option value="Bimestral">Bimestral</option>
            <option value="Trimestral">Trimestral</option>
            <option value="Cuatrimestral">Cuatrimestral</option>
            <option value="Semestral">Semestral</option>
            <option value="Anual">Anual</option>
          </select>
        </div>
        @if (frecuencia !== 'Unico') {
          <div class="flex items-center gap-2">
            <label for="eventos" class="font-bold text-black shrink-0">Eventos:</label>
            <input id="eventos" type="number" min="1" step="1" class="input input-bordered input-sm w-20" [(ngModel)]="eventos" name="eventos" />
          </div>
        }
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label for="cargoComunidadResidente" class="font-bold text-black shrink-0">Lista de cargos:</label>
        <select id="cargoComunidadResidente" class="select select-bordered max-w-md flex-1 min-w-0" [(ngModel)]="cargoComunidadId" name="cargoComunidadResidente" (ngModelChange)="onCargoComunidadChange()">
          <option value="">Seleccione un cargo</option>
          @for (c of cargosComunidad(); track c.id) {
            <option [value]="c.id">{{ c.concepto }} {{ c.monto != null ? (' - ' + (c.monto | number:'1.2-2')) : '' }}</option>
          }
        </select>
      </div>

      <div class="form-control w-full">
        <label class="label py-0" for="descripcion"><span class="label-text font-bold text-black">Descripción:</span></label>
        <textarea id="descripcion" class="textarea textarea-bordered w-full min-h-[80px]" [(ngModel)]="form.descripcion" name="descripcion" placeholder="Descripción del cargo"></textarea>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <label for="monto" class="font-bold text-black shrink-0">Monto:</label>
          <input id="monto" type="number" step="0.01" min="0" class="input input-bordered input-sm w-28" [(ngModel)]="form.monto" name="monto" required placeholder="0.00" />
        </div>
        <div class="flex items-center gap-2">
          <label for="estatus" class="font-bold text-black shrink-0">Estatus:</label>
          <select id="estatus" class="select select-bordered select-sm w-32" [(ngModel)]="form.estatus" name="estatus" required [disabled]="!isEditMode()">
            @for (opt of estatusOpciones; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
            }
          </select>
        </div>
      </div>

      <div class="flex justify-center gap-3 pt-4">
        <button type="submit" class="btn btn-primary text-white" [disabled]="isSaving()">
          @if (isSaving()) {
            <span class="loading loading-spinner loading-sm"></span>
            Guardando...
          } @else {
            Guardar
          }
        </button>
        <button type="button" class="btn btn-ghost" (click)="cancel()">
          Cancelar
        </button>
      </div>
    </form>

    <dialog id="confirmSaveCargoModal" class="modal modal-bottom sm:modal-middle">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
          <i class="fa-solid fa-circle-check text-primary"></i>
          Confirmar información a guardar
        </h3>
        <p class="text-sm text-base-content/80 mb-3">Revise los datos antes de guardar:</p>
        <dl class="space-y-2 text-sm">
          <div class="flex gap-2">
            <dt class="font-bold text-black shrink-0">Residente:</dt>
            <dd>{{ confirmacionResidenteNombre }}</dd>
          </div>
          <div class="flex gap-2">
            <dt class="font-bold text-black shrink-0">Fecha:</dt>
            <dd>{{ form.fecha }}</dd>
          </div>
          <div class="flex gap-2">
            <dt class="font-bold text-black shrink-0">Descripción:</dt>
            <dd class="break-words">{{ form.descripcion || '—' }}</dd>
          </div>
          <div class="flex gap-2">
            <dt class="font-bold text-black shrink-0">Monto:</dt>
            <dd>{{ form.monto | number:'1.2-2' }}</dd>
          </div>
          @if (frecuencia !== 'Unico') {
            <div class="flex gap-2">
              <dt class="font-bold text-black shrink-0">Eventos:</dt>
              <dd>{{ eventos }}</dd>
            </div>
            <div class="flex gap-2">
              <dt class="font-bold text-black shrink-0">Total:</dt>
              <dd>{{ (form.monto * eventos) | number:'1.2-2' }}</dd>
            </div>
          }
          <div class="flex gap-2">
            <dt class="font-bold text-black shrink-0">Estatus:</dt>
            <dd>{{ form.estatus }}</dd>
          </div>
        </dl>
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" (click)="closeConfirmModal()">Cancelar</button>
          <button type="button" class="btn btn-primary text-white" (click)="save()">
            Confirmar y guardar
          </button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button type="button" (click)="closeConfirmModal()">Cerrar</button>
      </form>
    </dialog>
  }
  </div>
</div>
