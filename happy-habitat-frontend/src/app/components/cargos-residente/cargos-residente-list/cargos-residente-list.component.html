<div class="p-4">
  <div class="mb-6 flex items-center justify-between gap-4 flex-wrap">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fa-solid fa-receipt text-primary"></i>
      Cargos a residentes
    </h1>

    <div class="flex items-center gap-2 flex-wrap">
      <hh-community-filter
        [communities]="comunidadesAsociadas()"
        [selectedId]="selectedComunidadId()"
        (selectedIdChange)="onComunidadChange($event)"
      />
      <select
        class="select select-bordered w-50 shrink-0"
        [ngModel]="selectedResidentId()"
        (ngModelChange)="onResidentChange($event)"
        [disabled]="!selectedComunidadId()"
      >
        <option value="">Seleccione un residente</option>
        @if (selectedComunidadId()) {
          <option value="all">Todos los residentes</option>
        }
        @for (r of residentsOptions(); track r.residentId ?? r.id) {
          <option [value]="r.residentId ?? r.id">{{ r.fullname }} {{ r.number ? '(' + r.number + ')' : '' }}</option>
        }
      </select>
      <a
        [routerLink]="selectedResidentId() && selectedResidentId() !== 'all' ? ['/admincompany/cargos-residente/nuevo', selectedResidentId()] : null"
        [queryParams]="selectedComunidadId() ? { comunidad: selectedComunidadId(), residente: selectedResidentId() } : null"
        class="btn btn-primary btn-sm btn-square flex items-center justify-center text-white shrink-0"
        [class.btn-disabled]="!selectedResidentId() || selectedResidentId() === 'all'"
        [attr.aria-disabled]="!selectedResidentId() || selectedResidentId() === 'all'"
        (click)="(!selectedResidentId() || selectedResidentId() === 'all') && $event.preventDefault()"
        title="Nuevo cargo"
      >
        <i class="fa-solid fa-plus"></i>
      </a>
    </div>
  </div>

  @if (comunidadesAsociadas().length === 0) {
    <div class="alert alert-warning mb-6">
      <i class="fa-solid fa-triangle-exclamation mr-2"></i>
      <span>No tienes comunidades asociadas. Contacta al administrador del sistema.</span>
    </div>
  }

  @if (!selectedComunidadId()) {
    <div class="alert alert-info mb-6">
      <i class="fa-solid fa-info-circle mr-2"></i>
      <span>Selecciona una comunidad para ver los cargos de los residentes.</span>
    </div>
  }

  @if (selectedComunidadId() && !selectedResidentId()) {
    <div class="alert alert-info mb-6">
      <i class="fa-solid fa-info-circle mr-2"></i>
      <span>Selecciona un residente o "Todos los residentes" para ver los cargos.</span>
    </div>
  }

  @if (selectedResidentId() && isLoading()) {
    <div class="flex justify-center items-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
      <span class="ml-4">Cargando cargos...</span>
    </div>
  } @else if (selectedResidentId()) {
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead class="bg-secondary text-white [&_th]:rounded-none [&_th]:text-white">
          <tr>
            <th class="w-12">#</th>
            @if (selectedResidentId() === 'all') {
              <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('residente')">
                <span class="flex items-center gap-1">
                  Residente
                  @if (sortColumn() === 'residente') {
                    <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                  } @else {
                    <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                  }
                </span>
              </th>
            }
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('fecha')">
              <span class="flex items-center gap-1">
                Fecha
                @if (sortColumn() === 'fecha') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('descripcion')">
              <span class="flex items-center gap-1">
                Descripción
                @if (sortColumn() === 'descripcion') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('monto')">
              <span class="flex items-center gap-1">
                Monto
                @if (sortColumn() === 'monto') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('estatus')">
              <span class="flex items-center gap-1">
                Estatus
                @if (sortColumn() === 'estatus') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @if (cargosPaginados().length === 0) {
            <tr>
              <td [attr.colspan]="selectedResidentId() === 'all' ? 7 : 6" class="text-center py-8 text-gray-500">
                <i class="fa-solid fa-inbox mr-2"></i>
                No se encontraron cargos
              </td>
            </tr>
          } @else {
            @for (cargo of cargosPaginados(); track cargo.id; let index = $index) {
              <tr class="cursor-pointer hover:bg-base-200 transition-colors" (click)="viewCargoDetail(cargo)">
                <td><span class="text-sm">{{ (currentPage() - 1) * pageSize() + index + 1 }}</span></td>
                @if (selectedResidentId() === 'all') {
                  <td>{{ cargo.residentName || '—' }}{{ cargo.residentNumber ? ' (' + cargo.residentNumber + ')' : '' }}</td>
                }
                <td>{{ formatDate(cargo.fecha) }}</td>
                <td class="max-w-[200px] truncate" [title]="cargo.descripcion">{{ cargo.descripcion || '—' }}</td>
                <td class="font-mono">{{ cargo.monto | number:'1.2-2' }}</td>
                <td>
                  <span class="badge badge-sm" [class.badge-success]="cargo.estatus === 'Pagado'" [class.badge-warning]="cargo.estatus === 'Activo' || cargo.estatus === 'Pago Parcial'" [class.badge-ghost]="cargo.estatus === 'Cancelado'">{{ cargo.estatus }}</span>
                </td>
                <td>
                  <div class="flex gap-1 items-center">
                    <a
                      [routerLink]="['/admincompany/cargos-residente/editar', cargo.id]"
                      [queryParams]="{ comunidad: selectedComunidadId() || null, residente: selectedResidentId() || null }"
                      class="btn btn-square btn-ghost bg-yellow-500"
                      (click)="$event.stopPropagation()"
                      title="Editar"
                    >
                      <i class="fa-solid fa-pen"></i>
                    </a>
                    <button
                      type="button"
                      class="btn btn-square btn-ghost text-error"
                      (click)="$event.stopPropagation(); openDeleteModal(cargo)"
                      title="Eliminar"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    @if (selectedResidentId() && totalPages() > 0) {
      <div class="flex items-center gap-4 mt-4">
        <div class="flex-1 min-w-0">
          <p class="text-sm text-base-content/70">
            Mostrando {{ cargosPaginados().length }} de {{ totalCount() }} cargo(s)
          </p>
        </div>
        <div class="flex justify-center flex-shrink-0">
          <div class="join">
            <button type="button" class="join-item btn btn-sm" [class.btn-disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">« Anterior</button>
            @for (p of paginasVisibles(); track p) {
              <button type="button" class="join-item btn btn-sm" [class.btn-active]="p === currentPage()" (click)="goToPage(p)">{{ p }}</button>
            }
            <button type="button" class="join-item btn btn-sm" [class.btn-disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">Siguiente »</button>
          </div>
        </div>
        <div class="flex justify-end flex-1 min-w-0">
          <label class="flex items-center gap-2 text-sm">
            <span class="text-base-content/70 whitespace-nowrap">Mostrar por página:</span>
            <select class="select select-bordered select-sm w-20" [ngModel]="pageSize()" (ngModelChange)="onPageSizeChange($event)">
              @for (opt of pageSizeOptions; track opt) {
                <option [value]="opt">{{ opt }}</option>
              }
            </select>
          </label>
        </div>
      </div>
    }
  }

  <dialog id="deleteCargoModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <i class="fa-solid fa-triangle-exclamation text-error"></i>
        <span>Confirmar Eliminación</span>
      </h3>
      @if (cargoToDelete()) {
        <p class="py-4">¿Está seguro de que desea eliminar este cargo?</p>
        <p class="text-sm text-base-content/70 mb-4">Esta acción no se puede deshacer.</p>
      }
      <div class="modal-action">
        <button class="btn btn-ghost" (click)="closeDeleteModal()">Cancelar</button>
        <button type="button" class="btn btn-ghost bg-red-500 text-white min-w-28" (click)="confirmDeleteCargo()">
          <i class="fa-solid fa-trash mr-2"></i>Eliminar
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button type="button" (click)="closeDeleteModal()">Cerrar</button>
    </form>
  </dialog>
</div>
