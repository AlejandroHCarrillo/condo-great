<div class="p-4">
  <div class="mb-6 flex items-center justify-between gap-4 flex-wrap">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fa-solid fa-ticket text-primary"></i>
      Gestión de Tickets
    </h1>

    <hh-community-filter
      [communities]="comunidadesAsociadas()"
      [selectedId]="selectedComunidadId()"
      [showAllOption]="true"
      (selectedIdChange)="onComunidadChange($event)"
    />
  </div>

  @if (comunidadesAsociadas().length === 0) {
    <div class="alert alert-warning mb-6">
      <i class="fa-solid fa-triangle-exclamation mr-2"></i>
      <span>No tienes comunidades asociadas. Contacta al administrador del sistema.</span>
    </div>
  }

  @if (!selectedComunidadId()) {
    <div class="alert alert-info mb-6">
      <i class="fa-solid fa-info-circle mr-2"></i>
      <span>Selecciona una comunidad para ver los tickets.</span>
    </div>
  }

  @if (selectedComunidadId() && isLoading()) {
    <div class="flex justify-center items-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
      <span class="ml-4">Cargando tickets...</span>
    </div>
  } @else if (selectedComunidadId()) {
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead class="bg-secondary text-white [&_th]:rounded-none [&_th]:text-white">
          <tr>
            <th class="w-12">#</th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('fechaReporte')">
              <span class="flex items-center gap-1">
                Fecha
                @if (sortColumn() === 'fechaReporte') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('residentName')">
              <span class="flex items-center gap-1">
                Residente
                @if (sortColumn() === 'residentName') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('tipoReporteNombre')">
              <span class="flex items-center gap-1">
                Tipo
                @if (sortColumn() === 'tipoReporteNombre') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th class="cursor-pointer select-none hover:opacity-90 transition-opacity" (click)="setSort('statusCode')">
              <span class="flex items-center gap-1">
                Estado
                @if (sortColumn() === 'statusCode') {
                  <i class="fa-solid fa-sort-{{ sortDirection() === 'asc' ? 'up' : 'down' }} text-white text-xs"></i>
                } @else {
                  <i class="fa-solid fa-sort text-white/70 text-xs"></i>
                }
              </span>
            </th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @if (ticketsOrdenados().length === 0) {
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                <i class="fa-solid fa-inbox mr-2"></i>
                No hay tickets en esta comunidad
              </td>
            </tr>
          } @else {
            @for (ticket of ticketsOrdenados(); track ticket.id; let i = $index) {
              <tr class="hover:bg-base-200 transition-colors">
                <td class="font-mono text-sm">{{ i + 1 }}</td>
                <td>{{ formatDate(ticket.fechaReporte) }}</td>
                <td class="font-medium">{{ ticket.residentName ?? '—' }}</td>
                <td>{{ ticket.tipoReporteNombre ?? '—' }}</td>
                <td>
                  <span class="badge badge-ghost">{{ ticket.statusCode ?? ticket.statusDescripcion ?? '—' }}</span>
                </td>
                <td>
                  <button
                    type="button"
                    class="btn btn-ghost btn-sm"
                    (click)="viewTicket(ticket)"
                  >
                    <i class="fa-solid fa-eye"></i>
                    Ver
                  </button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
    @if (ticketsOrdenados().length > 0) {
      <p class="text-sm text-base-content/70 mt-2">
        Mostrando {{ ticketsOrdenados().length }} ticket(s)
      </p>
    }
  }
</div>
